---
title: "Temperature performance modeling"
author: "PURA acuicultura"
date: "4/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
In Chapter 2 we developed a cumulative growth model that takes an individual fish weight at the beginning of a 24-hour interval and returns the expected weight at the end of the 24-hour interval as input for the following day. At the same time, we also demonstrated how multiplying the estimated daily weight gain by a random error term 'individualized' the 'lifetime' growth pattern expressed by the model. In this chapter, the same principle will be applied to model fish growth throughout seasonally variable temperature regimes. More specifically, throughout the sinusoidal temperature models developed in Chapter 4.

## Libraries used

```{r tpm_libraries, warning = FALSE, message = FALSE, error = FALSE}
library(tidyverse)
```


## Introduction
Being ectothermic, fish metabolism is influenced by the temperature of the surrounding water. As a general model, growth increases with increasing temperature until a thermal optimum is achieved. While some individual variation certainly exists, thermal optimum are principally species specific. For example, while the thermal optimum of salmon is around 14$^\circ$C, for tilapia it is nearer to 28$^\circ$C. Above the thermal optimum, growth decreases with increasing temperature.

## Parabolic performance x temperature relationships
Based on this general model, one might choose to model 'performance as a function of temperature' using something akin to a convex parabola. The following code creates just such a curve for tilapia. The curve employs the vertex form of the parabola equation such that the temperature optimum `T_opt` for tilapia (NB: 28$^\circ$C) can be directly entered into the equation, along with the performance maximum `P_max`, and the coefficient `a`, which dictates the direction and width of the parabola.

```{r tpm_parabola, fig.dim = c(10, 3), warning = FALSE, message = FALSE, error = FALSE}
a <- -0.008 # dictates the direction and width of the parabola
T_opt <- 28 # temperature optimum of the species
P_max <- 1 # perforamce maximum

TEMP <- seq(0, 40, by = 1)
PERF <- a * (TEMP - T_opt)^2 + P_max
df_parab <- data.frame(TEMP, PERF)

df_parab %>%
  ggplot() +
  geom_vline(xintercept = 20, color = 'red', size = 1.5, linetype = 'dashed') +
  geom_vline(xintercept = 36, color = 'red', size = 1.5, linetype = 'dashed') +
  geom_vline(xintercept = 26, color = 'green', size = 1.5, linetype = 'dashed') +
  geom_vline(xintercept = 30, color = 'green', size = 1.5, linetype = 'dashed') +
  geom_vline(xintercept = T_opt, color = 'black', size = 1.5) +
  geom_line(aes(x = TEMP, y = PERF), color = 'blue', size = 1.5) +
  coord_cartesian(ylim = c(0, 1)) +
  theme_bw()
```

From the figure it can be seen that performance ranges from 0 to 1. A performance maximum of 1 is used throughout the models developed here. As such, daily growth can easily be 'regressed' through direct multiplication with performance. This will be discussed in great detail in chapter 5. For now, notice that performance is 0 for temperatures below 17 and greater than 39$^\circ$C. Within 17 and 39$^\circ$C, performance first increases to a value of 1 at 28$^\circ$C before again decreasing towards 0. Several vertical lines were added to the figure for reference. Red lines at 28 &#177; 8$^\circ$C represent the tolerable range of the species and green lines at 28 &#177; 2$^\circ$C the optimum range. Within the optimum range, performance levels are greater than 0.98. Outside the tolerable range, performance levels fall below 0.5.

While the parabola model provides a good general approximation of the relationship between performance and temperature, it is not perfect. For one thing, the relationship is generally not symmetrical such that the increase in performance below the temperature optimum is more gradual than the decrease in performance that follows. Furthermore, because parabolic relationships extend below 0 performance, the rate of performance change becomes increasingly severe as the modeled thermal limits of the species are approached (NB: 17 and 39$^\circ$C for the example shown). While a parabolic relationship is frequently used for temperatures above the optimum, a sigmoidal relationship seems to more accurately reflect the relationship for temperature below the optimum. 

## Sigmoidal performance x temperature relationships
Performance x temperature relationships sometimes have the appearance of left skewed normal distributions such that both the x-axis acts as an assymptote to performance beyond the lower and upper thermal limits. Although formulas for non-normal curves exist it can be slightly less cumbersome to combine two sigmoidal curves. More specifically, a positive coefficient sigmoid  terminating at the temperature optimum is joined to a negative coefficient sigmoid commencing at the temperature optimum. The process is demonstrated here.

```{r tpm_sig_1, fig.dim = c(5, 3), warning = FALSE, message = FALSE, error = FALSE}
#__1. Sigmoid from 0 to T optimum ####
T_min <- 20
beta_1 <- 1.7

TEMP = seq(0, T_opt, by = 0.1)
PERF = 1 / (1 + beta_1^(-TEMP + T_min))
df_sig_1 <- data.frame(TEMP, PERF)

# max(df_sig_1$PERF) # maintain this value for written equation

df_sig_1 %>%
  mutate(PERF = PERF / max(PERF)) %>%
  ggplot() +
  geom_line(aes(x = TEMP, y = PERF), size = 1.5, color = 'blue') +
  theme_bw()
```


```{r tpm_sig_2, fig.dim = c(5, 3), warning = FALSE, message = FALSE, error = FALSE}
#__2. Sigmoid from T optimum to 40 ####
T_max <- 33
beta_2 <- 0.4

TEMP = seq(T_opt, 56, by = 0.1)
PERF = 1 / (1 + beta_2^(-TEMP + T_max))
df_sig_2 <- data.frame(TEMP, PERF)

# max(df_sig_2$performance) # maintain this value for written equation

df_sig_2 %>%
  mutate(PERF = PERF - max(PERF)) %>%
  ggplot() +
  geom_line(aes(x = TEMP, y = PERF), size = 1.5, color = 'blue') +
  theme_bw()
```


```{r tpm_sig, fig.dim = c(10, 3), warning = FALSE, message = FALSE, error = FALSE}
TEMP = seq(0, 56, by = 1)
PERF <- ifelse(TEMP <= T_opt,
               (1 / (1 + beta_1^(-TEMP + T_min))) / max(df_sig_1$PERF),
               (1 / (1 + beta_2^(-TEMP + T_max))) / max(df_sig_2$PERF))

df_sig <- data.frame(TEMP, PERF)

df_sig %>%
  ggplot() +
  geom_vline(xintercept = T_min, color = 'red', size = 1.25, linetype = 'dashed') +
  geom_vline(xintercept = T_max, color = 'red', size = 1.25, linetype = 'dashed') +
  geom_vline(xintercept = 26, color = 'dark green', size = 1.25, linetype = 'dashed') +
  geom_vline(xintercept = 30, color = 'dark green', size = 1.25, linetype = 'dashed') +
  geom_vline(xintercept = T_opt, color = 'black', size = 1.25) +
  geom_line(aes(x = TEMP, y = PERF), size = 1.25, color = 'blue') +
  theme_bw()
```


## Combined performance x temperature relationship
Now that we have explored parabolic and sigmoidal performance x temperature relationships, we might also consider a combined sigmoid/parabolic relationship.  
